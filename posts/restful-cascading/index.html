<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> RESTful Cascading in Rails | Hello, World extended </title>
  <meta name="description" content="RESTful Cascading in Rails">
  <meta name="keywords" content="rails, cascading, touch, updated_at">
  <link rel="stylesheet" href="/css/main.css">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="theme-color" content="#2ecc71">
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?autoload=true&skin=sunburst"></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-52446115-1']);
    _gaq.push(['_trackPageview']);
    (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</head>

<body class="single">
  <main class="container">
    <header class="site-header">
      <div class="container txt-center">
        <nav class="navbar">
          <ul>
            <li><a href="/">home</a></li>
            <li class="divider">&bull;</li>
            <li><a href="/about">about</a></li>
            <li class="divider">&bull;</li>
            <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
          </ul>
        </nav>
        <a href="/" class="author-thumb">
          <img src="/images/author.jpg" alt="Author thumbnail" class="dot">
        </a>
        <h1>Hello, World extended <small>...</small></h1>

        <hr class="hr">
      </div>
    </header>
    <section class="main-content">
      <article class="post">
        <header class="post-header">
          <h1 class="post-title">RESTful Cascading in Rails</h1>
          <p class="post-meta">March 28, 2020</p>
        </header>
        <h4>Why Cascade?</h4>
        <p>
          One of the primary benefits of using REST architecture in designing our APIs is that it helps us keep our server-side code simple. It is not difficult to imagine a very simple application where creating, editing, and deleting an instance of a class does not alter any other instances. Put another way, we are imagining an app with no relationships between models. However, the fact is, very few practical object-oriented apps above the most simplistic lack join tables and relationships.
        </p>

        <p>
          In Rails, we can set instances' relationships to other classes' instances in our models. Those keywords that Rails developers have used so often -- 'belongs_to', 'has_many', and 'has_one' -- appear at the top of most model classes.
        </p>

        <p>
            In this blog, I am going to be focusing on the one-to-many relationship. These relationships need to be carefully coded for all potentially transformative HTTP verbs: POST, PATCH/PUT, DELETE. Instances on the many side of the one-to-many are dependent upon the one side. So, if something happens to the one, we may want to also touch on the many. Likewise, if something happens to one of our many-side instances, we may want to make an update to our one. While we could effectively code any edit into the controller actions, Rails provides a few tools to help us out with cascading updates and deletions.
        </p>

        <h4>Create</h4>

        <p>
            Let's say we are building an app like <a href='http://succotash-app.herokuapp.com' target='_blank'>Succotash</a>. When a user creates a new field, we want to build out the associated subunits for that field, and then also a few initial stages (time periods) for the app. In this case, the field has many subunits (beds), which in turn have many stages. We need to cascade these creations and associate them all together, while only really receiving data for our top-level from the front-end.
        </p>

        <p>
            The code below shows how we can create so many instances from just one request. Notice, however, that the beds and stages all are provided with what are essentially default values. (This code is a simplified version of what is used in the app.)
        </p>

<pre class="prettyprint lang=rb">
<code>
ADD GITHUB SNIPPET
</code>
</pre>

        <p>
          Rather than having to write a few chained methods on our front-end that cycle through three or more request/response cycles, we have only hit our backend once and managed to create all the relationships in one controller method.
        </p>

        <p>
            While we could also use a similar pattern to cascade our updates and deletions, Rails provides us with some tools to simplify the process.
        </p>


        <h4>Update</h4>

        <p>
            The controller is also the place you want to make any updates to different instances using the same pattern demonstrated above. But what if you just want to cascade your updated_at times? Rails and ActiveRecord provides a neat little keyword that can cascade our updated_at (or other) dates. 
        </p>

        <p>
            Thinking again about Succotash, it is indeed possible that a user could update Stages and Beds without ever actually touching our Field instance. But to our user, they think they are updating the field when they update its children. Considering our profile page sorts fields by their updated_at time, we definitely want to update the field.
        </p>

        <p>
            There are two ways to do this: in the controller and in the model. Both use the same keyword: <a href='https://apidock.com/rails/ActiveRecord/Persistence/touch' target='_blank'>touch</a>. To do so in the controller:
        </p>

<pre class="prettyprint lang=rb">
  <code>
GITHUB SNIPPET HERE
  </code>
  </pre>

        <p>
            By calling the touch method on an instance, it updates the field provided to the present time. It does not need to be our updated_at field either. We could 'touch' any field where the schema allows a datetime and update it to the present time by passing that field's name as an argument to touch.
        </p>

        <p>
            My prefered method of updating the updated_at field, however, is to provide the touch method to my models. This fix eliminates the need to add the extra code to the controller.
        </p>

        <pre class="prettyprint lang=rb">
  <code>
 SNIPPET GOES HERE
  </code></pre>
        <p>
          With the 'prepend' keyword, our module shares its methods as instance classes and overwrites any instance
          classes already located in our class. This is quite different from a class inheritance structure, where a
          method of a parent class would not overwrite the method in a child class. Our module is able to do this by
          forcing itself to position one in the ancestors list, even before the name of the class it was called upon!
        </p>

        <p>
          And finally, we can <strong>include</strong> a module in a class.
        </p>

        <pre class="prettyprint lang=rb">
<code>
module MyModule
    def clarity
        "This code is in the clarity method of MyModule"
    end
 
    def num
        @num
    end

    def add_one
        self.num + 1
    end   
end

class MyClass
    include MyModule

    def initialize(num)
        @num = num
    end


    def clarity
        "this code is in the clarity instance method of MyClass"
    end
end

instance1 = MyClass.new(1)

MyClass.clarity # => undefined method `clarity' for MyClass:Class
instance1.clarity # => 'this code is in the clarity instance method of MyClass'
instance1.add_one # => 2
MyClass.ancestors.first # => MyClass
</code></pre>

        <p>
          Again, calling our modules method as a class method results in a no method error, and, unlike with 'prepend',
          by using the 'include' keyword, our class's instance methods have priority over those in the module. However,
          we are able to call other module-based methods on our instances and can even use instance variables specific
          to our class within those methods. We can even house our getter and setter methods within the module.
        </p>

        <p>
          Because Ruby goes up the family tree to find relevant instance methods when they are called, this is key to
          determining when to include a module verses when to prepend a module with a class. Extend is used for class
          methods only.
        </p>

        <h4>When Should We Incorporate Modules?</h4>

        <p>
          Moving beyond the obvious answer that we use modules such as Enumerables and Math on a day-to-day basis and
          that various standard support products such as ActiveRecord are themselves modules, modules should probably be
          used fairly sparingly in simple applications. While modules have the ability to DRY out code, mixing too many
          modules into classes for a small set of methods can add too much abstraction.
        </p>

        <img src="https://media.giphy.com/media/gOPWeWB9fuxm8/giphy.gif" alt="Mix mix mix" style="display: block; margin-left: auto; margin-right: auto;">
        <p class="iframelabel"><a href="https://giphy.com/gifs/weekend-dc-bets-gOPWeWB9fuxm8">via GIPHY</a></p>

        <p>
          Is there a hint that we should be using a module rather than placing methods in classes? If code appears to be
          repetitive across our classes, then placing methods in a module could probably take their place. Another
          situation is if we have a set of methods that are not obviously related to a single class but have some kind
          of commonality (such as all our math functions), they probably belong in a module.
        </p>



    </section>
    <div class="post-content">
      <aside class="share">
        <span>Share this: </span>
        <a href="http://twitter.com/share?text=Ruby Modules: The When, Where, and How&amp;url=http://mattbechtel1.github.io/ruby-modules-the-when-where-and-how&amp;hashtags=web,dev,blog,soudev&amp;via=nandomoreirame"
          onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="icon icon-twitter-rounded"></i>
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://mattbechtel1.github.io/ruby-modules-the-when-where-and-ho"
          onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="icon icon-facebook-rounded"></i>
        </a>
      </aside>
    </div>
    <hr>
    <aside id="comments" class="disqus">
      <h3>Comments</h3>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'hello-world-extended';
        var disqus_identifier = '/ruby-modules-the-when-where-and-how';
        var disqus_title = 'Ruby Modules: The When, Where, and How';
        var disqus_url = 'http://mattbechtel1.github.io';
        (function () { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://hello-world-extended.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
          Disqus.</a></noscript>


    </aside>
    </article>
    </section>
    <div class="clearfix"></div>
    <footer class="site-footer txt-center">
      <hr>
      <ul class="social">
        <li><a href="" target="_blank"><i class="icon icon-"></i></a></li>
        <li><a href="http://github.com/mattbechtel1" target="_blank"><i class="icon icon-github"></i></a></li>
        <li><a href="" target="_blank"><i class="icon icon-"></i></a></li>
        <li><a href="http://twitter.com/mattbechtel1" target="_blank"><i class="icon icon-twitter"></i></a></li>
        <li><a href="" target="_blank"><i class="icon icon-"></i></a></li>
        <li><a href="http://linkedin.com/in/mbechtel" target="_blank"><i class="icon icon-linkedin"></i></a></li>
      </ul>
      <small>&copy; 2019 All rights reserved. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i
          class="icon icon-heart"></i></small>
      <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small>
    </footer>
  </main>
  </main> 
</body>

</html>
